<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reservas — Chanchullo la obra</title>
  <style>
    :root{--accent:#7c3aed; --bg:#f6f7fb}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:#111; margin:0; padding:24px}
    .container{max-width:920px; margin:0 auto; background:white; padding:20px; border-radius:10px; box-shadow:0 6px 22px rgba(12,20,30,0.08)}
    h1{margin:0 0 8px; font-size:2.2rem; color:#4c1d95}
    h1 span{font-weight:700; color:#6d28d9}
    p.lead{margin:0 0 18px; color:#444}
    form{display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:end}
    label{font-size:13px; color:#333}
    input, select{width:100%; padding:10px 12px; border-radius:8px; border:1px solid #ddd; font-size:14px}
    button{grid-column:1 / -1; padding:10px 14px; border-radius:8px; border:0; background:var(--accent); color:white; font-weight:600; cursor:pointer}
    .status{margin-top:14px}
    .card{padding:12px; border-radius:8px; background:#fafafa; border:1px solid #eee}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th, td{padding:8px; text-align:left; border-bottom:1px solid #eee}
    .small{font-size:13px;color:#666}
    .controls{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
    .delBtn{background:#e53e3e;color:white;border:0;padding:6px 10px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <h1>Reservas — <span>Chanchullo la obra</span></h1>
    <p class="lead">Seleccioná la función, ingresá nombre, teléfono y la cantidad de entradas. Cupo por función: <strong>50</strong>.</p>

    <!-- FORM -->
    <form id="reservaForm">
      <div>
        <label for="fecha">Función</label>
        <select id="fecha" required></select>
      </div>

      <div>
        <label for="cantidad">Cantidad de entradas</label>
        <select id="cantidad" required>
          <script>for(let i=1;i<=20;i++) document.write(`<option value="${i}">${i}</option>`)</script>
        </select>
      </div>

      <div>
        <label for="nombre">Nombre</label>
        <input id="nombre" type="text" required>
      </div>

      <div>
        <label for="telefono">Teléfono</label>
        <input id="telefono" type="tel" required>
      </div>

      <button id="btnSubmit">Reservar</button>
    </form>

    <div class="status" id="status"></div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:18px">
      <div class="card">
        <h3 style="margin:0 0 6px">Cupos restantes</h3>
        <div id="cuposList" class="small">Cargando...</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Administración</h3>
        <div class="controls" id="verReservasBtns"></div>
        <p class="small" style="margin-top:8px">Podés eliminar reservas si alguien cancela.</p>
      </div>
    </div>

    <div id="reservasTable" style="margin-top:18px"></div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js'
      import { getFirestore, doc, setDoc, getDoc, collection, getDocs, runTransaction, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js'

      const firebaseConfig = {
        apiKey: "AIzaSyAPPt23MiqeGWdpJhuQtGxfKYlgQRE1hVA",
        authDomain: "gestor-reservas-1f040.firebaseapp.com",
        projectId: "gestor-reservas-1f040",
        storageBucket: "gestor-reservas-1f040.firebasestorage.app",
        messagingSenderId: "951777953877",
        appId: "1:951777953877:web:eee0053474a22c9310acdc",
        measurementId: "G-CNF5PLZQTR"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const metaDocRef = doc(db, 'meta', 'funciones');
      const reservasCol = collection(db, 'reservas');

      let funciones = [];

      async function cargarFunciones() {
        const snap = await getDoc(metaDocRef);
        if (!snap.exists()) return;
        const cupos = snap.data().cupos || {};
        funciones = Object.keys(cupos).sort();
      }

      const statusEl = document.getElementById('status');
      const cuposList = document.getElementById('cuposList');
      const reservasTable = document.getElementById('reservasTable');
      const verReservasBtns = document.getElementById('verReservasBtns');

      // inicializa doc meta
      async function ensureMeta(){
        const snap = await getDoc(metaDocRef);
        if(!snap.exists()){
          const init = {};
          funciones.forEach(f=> init[f] = 50);
          await setDoc(metaDocRef, {cupos:init, updated: new Date().toISOString()});
        }
      }

      async function renderCupos(){
        const snap = await getDoc(metaDocRef);
        if(!snap.exists()){ cuposList.innerText = 'Sin datos.'; return }
        const data = snap.data().cupos || {};
        let html = '<table><tr><th>Función</th><th>Cupos restantes</th></tr>';
        funciones.forEach(f=>{
          html += `<tr><td>${formatFecha(f)}</td><td><strong>${data[f] ?? 0}</strong></td></tr>`;
        });
        html += '</table>';
        cuposList.innerHTML = html;
      }

      function formatFecha(fechaStr){
        const parts = fechaStr.includes('-') ? fechaStr.split('-') : fechaStr.split('/');
        if(parts.length < 3) return fechaStr;
        let [a,b,c] = parts.map(p=>p.trim());
        if(a.length === 4) { // formato yyyy-mm-dd
          const d = new Date(Number(a), Number(b)-1, Number(c));
          return d.toLocaleDateString('es-AR', { weekday:'long', day:'numeric', month:'numeric', year:'numeric' });
        } else { // formato dd/mm/yyyy
          const d = new Date(Number(c), Number(b)-1, Number(a));
          return d.toLocaleDateString('es-AR', { weekday:'long', day:'numeric', month:'numeric', year:'numeric' });
        }
      }

      async function hacerReserva({fecha, nombre, telefono, cantidad}){
        cantidad = Number(cantidad);
        try{
          await runTransaction(db, async (t)=>{
            const metaSnap = await t.get(metaDocRef);
            const cupos = metaSnap.data().cupos || {};
            const disponible = Number(cupos[fecha] ?? 0);
            if(disponible < cantidad) throw new Error('No hay suficientes entradas');
            cupos[fecha] = disponible - cantidad;
            t.update(metaDocRef, {cupos, updated: new Date().toISOString()});
            const newResRef = doc(collection(db,'reservas'));
            t.set(newResRef, {fecha, nombre, telefono, cantidad, created: new Date().toISOString()});
          });
          return {ok:true};
        }catch(e){
          return {ok:false, error:e.message};
        }
      }

      document.getElementById('reservaForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        statusEl.innerText = 'Procesando...';
        const fecha = document.getElementById('fecha').value;
        const cantidad = document.getElementById('cantidad').value;
        const nombre = document.getElementById('nombre').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const res = await hacerReserva({fecha, nombre, telefono, cantidad});
        if(res.ok){
          statusEl.innerHTML = `<span style="color:green">Reserva creada: ${nombre} — ${cantidad} entrada(s) para ${formatFecha(fecha)}</span>`;
          document.getElementById('reservaForm').reset();
          renderCupos();
        }else{
          statusEl.innerHTML = `<span style="color:crimson">Error: ${res.error}</span>`;
        }
      });

      async function verReservasPorFecha(fecha){
        reservasTable.innerHTML = `<p class="small">Cargando reservas para ${formatFecha(fecha)}...</p>`;
        const snap = await getDocs(reservasCol);
        const docs = snap.docs.filter(d => d.data().fecha === fecha);
        if (docs.length === 0){
          reservasTable.innerHTML = `<p class="small">No hay reservas para ${formatFecha(fecha)}.</p>`;
          return;
        }
        let html = `<h3>Reservas para ${formatFecha(fecha)}</h3>`;
        html += '<table><tr><th>Nombre</th><th>Teléfono</th><th>Cantidad</th><th>Creado</th><th>Acción</th></tr>';
        docs.forEach(d=>{
          const r = d.data();
          html += `<tr>
            <td>${r.nombre}</td>
            <td>${r.telefono}</td>
            <td>${r.cantidad}</td>
            <td class="small">${new Date(r.created).toLocaleString()}</td>
            <td><button class="delBtn" data-id="${d.id}" data-fecha="${r.fecha}" data-cantidad="${r.cantidad}">Eliminar</button></td>
          </tr>`;
        });
        html += '</table>';
        reservasTable.innerHTML = html;

        document.querySelectorAll('.delBtn').forEach(btn=>{
          btn.addEventListener('click', async ev=>{
            const id = ev.target.dataset.id;
            const fecha = ev.target.dataset.fecha;
            const cantidad = Number(ev.target.dataset.cantidad);
            if(!confirm('¿Eliminar esta reserva?')) return;
            await runTransaction(db, async (t)=>{
              const metaSnap = await t.get(metaDocRef);
              const cupos = metaSnap.data().cupos || {};
              cupos[fecha] = (cupos[fecha] || 0) + cantidad;
              t.update(metaDocRef, {cupos, updated:new Date().toISOString()});
              t.delete(doc(db, 'reservas', id));
            });
            alert('Reserva eliminada.');
            renderCupos();
            ev.target.closest('tr').remove();
          });
        });
      }

      function poblarSelectFechas() {
        const sel = document.getElementById('fecha');
        sel.innerHTML = '';
        funciones.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = formatFecha(f);
          sel.appendChild(opt);
        });
      }

      function crearBotonesReservas() {
        verReservasBtns.innerHTML = '';
        funciones.forEach(f=>{
          const btn = document.createElement('button');
          btn.textContent = formatFecha(f);
          btn.style.background = '#444';
          btn.style.color = 'white';
          btn.style.padding = '8px 12px';
          btn.style.borderRadius = '6px';
          btn.addEventListener('click', ()=> verReservasPorFecha(f));
          verReservasBtns.appendChild(btn);
        });
      }

      async function subscribeCupos(){
        onSnapshot(metaDocRef, (snap)=>{
          if(!snap.exists()) return;
          renderCupos();
        });
      }

      (async ()=>{
        try {
          await cargarFunciones();
          await ensureMeta();
          await renderCupos();
          crearBotonesReservas();
          poblarSelectFechas();
          subscribeCupos();
        } catch(e){
          cuposList.innerText = 'Error al conectar con Firebase.';
        }
      })();
    </script>
  </div>
</body>
</html>

